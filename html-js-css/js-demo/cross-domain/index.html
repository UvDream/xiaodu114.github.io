<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跨域 cross domain - xiaodu114.github.io</title>
    <meta name="keywords" content="跨域,cross domain,同源,cors,postMessage">
    <meta name="description"
        content="跨域测试页面。主要测试了 iframe + document.domain | location.hash | window.name 方式、postMessage方式和JSONP方式，代理服务器、WebSocket、CORS等方式稍后介绍……">
    <link rel="stylesheet"
        href="https://unpkg.zhimg.com/material-components-web@latest/dist/material-components-web.css">
    <style>
        @font-face {
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: 400;
            src: url(https://fonts.gstatic.com/s/materialicons/v70/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }
    </style>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
        }

        body {
            background-color: #e6e6e6;
            overflow-y: auto;
        }

        .cross-domain-demo {
            width: 992px;
            margin-left: auto;
            margin-right: auto;
            background-color: #fff;
            padding-left: 150px;
            padding-right: 150px;
            padding-top: 30px;
            padding-bottom: 30px;
        }

        .help-text {
            color: #737373;
        }

        .indent-text {
            text-indent: 2em;
        }
    </style>
</head>

<body>
    <!-- github访问地址：/html-js-css/js-demo/cross-domain/index.html -->
    <div class="cross-domain-demo">
        <fieldset>
            <legend>参考链接</legend>
            <ul>
                <li>
                    <a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy"
                        target="_blank">浏览器的同源策略 - Web 安全 | MDN</a>
                </li>
                <li>
                    <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS"
                        target="_blank">跨源资源共享（CORS） - HTTP | MDN</a>
                </li>
                <li>
                    <a href="https://segmentfault.com/a/1190000011145364" target="_blank">前端常见跨域解决方案（全）-
                        SegmentFault</a>
                </li>
                <li>
                    <a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html"
                        target="_blank">浏览器同源政策及其规避方法 - 阮一峰的网络日志</a>
                </li>
            </ul>
        </fieldset>
        <p></p>
        <fieldset>
            <legend>有些还是可以跨域的</legend>
            <dl>
                <dt>link标签和url函数(图片、字体文件等)</dt>
                <dd>
                    <button class="mdc-fab" type="button">
                        <div class="mdc-fab__ripple"></div>
                        <span class="material-icons mdc-fab__icon">add</span>
                        <div class="mdc-fab__touch"></div>
                    </button>
                    <span class="help-text">这里使用了
                        <strong>
                            material-components-web样式
                        </strong>
                        和
                        <strong>
                            Material Icons字体图标（url中请求的字体图标）
                        </strong>
                    </span>
                </dd>
                <dt>script标签</dt>
                <dd>
                    <span class="help-text">这里使用了<strong>material-components-web JS</strong></span>
                    <div class="mdc-slider mdc-slider--discrete">
                        <input class="mdc-slider__input" type="range" min="0" max="100" value="50" name="volume"
                            step="10" aria-label="Discrete slider demo">
                        <div class="mdc-slider__track">
                            <div class="mdc-slider__track--inactive"></div>
                            <div class="mdc-slider__track--active">
                                <div class="mdc-slider__track--active_fill"></div>
                            </div>
                        </div>
                        <div class="mdc-slider__thumb">
                            <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                                <div class="mdc-slider__value-indicator">
                                    <span class="mdc-slider__value-indicator-text">
                                        50
                                    </span>
                                </div>
                            </div>
                            <div class="mdc-slider__thumb-knob"></div>
                        </div>
                    </div>
                </dd>
                <dt>img标签</dt>
                <dd>
                    <img src="https://www.baidu.com/img/flexible/logo/pc/result.png" alt="">
                    <span class="help-text">这里使用了<strong>百度LOGO</strong></span>
                </dd>
                <dt>video\audio标签（音乐来自咪咕音乐 music.migu.cn）</dt>
                <dd>
                    <video controls="" loop="" height="55px" width="100%" style="outline: none;">
                        <source
                            src="http://freetyst.nf.migu.cn/public/product8th/product38/2020/03/0216/2015%E5%B9%B409%E6%9C%8815%E6%97%A510%E7%82%B943%E5%88%86%E5%86%85%E5%AE%B9%E5%87%86%E5%85%A5%E7%9B%9B%E5%94%90%E6%97%B6%E7%A9%BA999%E9%A6%96/%E5%85%A8%E6%9B%B2%E8%AF%95%E5%90%AC/Mp3_64_22_16/60054041260.mp3"
                            type="audio/mpeg">
                    </video>
                </dd>
                <dt>iframe标签</dt>
                <dd>
                    <div class="help-text">
                        这种方式也是可以禁止的，<a href="https://developer.mozilla.org/zh-CN/" target="_blank">MDN Web 文档</a>就不行
                    </div>
                    <div class="help-text">这里使用iframe嵌入<strong>百度</strong></div>
                    <iframe src="https://www.baidu.com" frameborder="0" width="100%"></iframe>
                </dd>
            </dl>
        </fieldset>
        <p></p>
        <fieldset>
            <legend>你不能做哪些事情</legend>
            <dl>
                <dt>Cookie、LocalStorage 和 IndexDB 无法读取。</dt>
                <dt>DOM 无法获得。</dt>
                <dt>AJAX 请求不能发送。</dt>
            </dl>
        </fieldset>
        <p></p>
        <fieldset>
            <legend>怎么解决</legend>
            <dl>
                <dt>document.domain + iframe</dt>
                <dd>
                    <div class="help-text indent-text">
                        我是这样搭建测试环境的：搭建了一个站点，里面就两个页面：本页面和documentDomain1.html；之后需要修改hosts文件。
                        <ul>
                            <li>127.0.0.1 ddz.com</li>
                            <li>127.0.0.1 c1.ddz.com</li>
                            <li>127.0.0.1 c2.ddz.com</li>
                        </ul>
                    </div>
                    <div class="help-text indent-text">
                        ddz.com下的页面不能将“document.domain”设置为：c1.ddz.com
                        <span style="color: red;">
                            Uncaught DOMException: Failed to set the 'domain' property on 'Document': 'c1.ddz.com' is
                            not a suffix of 'ddz.com'.
                        </span>
                    </div>
                    <div class="help-text indent-text">
                        注意父子页面设置“document.domain”的顺序。如果子页面早于父页面设置并立即读取父页面的window的值，这时候还是会报跨域错误:
                        <span style="color: red;">
                            Uncaught DOMException: Blocked a frame with origin "http://c1.ddz.com" from accessing a
                            cross-origin frame.
                        </span>
                        也就是说在读取值之前，“document.domain”已经设置完成。
                    </div>
                    <div class="help-text indent-text">
                        即使ddz.com下的页面“document.domain”的值本身就是“ddz.com”，但是也必须显示设置
                    </div>
                    <!-- <script>
                        document.domain = 'ddz.com';
                        window.dd = "index.html";
                    </script>
                    <iframe id="frameDocumentDomain1" src="//c1.ddz.com/documentDomain1.html" width="100%"
                        onload="iframeDocumentDomain1Load()"></iframe>
                    <script>
                        var frameDocumentDomain1Dom = document.getElementById("frameDocumentDomain1");

                        function iframeDocumentDomain1Load() {
                            alert('获取子页面变量(dd)的值:' + frameDocumentDomain1Dom.contentWindow.dd);
                        }
                    </script> -->
                </dd>
                <dt>location.hash + iframe</dt>
                <dd>
                    <div class="help-text indent-text">
                        index.html页面可以通过"location.hash +
                        iframe"给跨域的页面locationHash1.html传值这个没有问题，问题是iframe中的页面怎么应答……他可以也通过"location.hash +
                        iframe"的方式传值给父页面同源的一个页面locationHash0.html，这个页面就可以操作他爷爷辈儿的"location.hash"了
                    </div>
                    <iframe src="//c1.ddz.com/locationHash1.html#comeFromIndexPage" width="100%"></iframe>
                    <script>
                        location.hash = "";
                        window.onhashchange = function () { //检测hash的变化
                            alert("我间接收到了locationHash1页面的hash反馈：" + location.hash);
                        }
                    </script>
                </dd>
                <dt>window.name + iframe</dt>
                <dd>
                    <div class="help-text indent-text">
                        index.html页面首先利用iframe加载跨域的页面"//ddz.com/windowName0.html"（设置"window.name"），onload之后再利用该iframe去加载和index.html同源的页面"//ddz.com/windowName0.html"，这时就可以利用iframe读取"contentWindow.name"，这里读到的就是跨域页面的"window.name"；注意：同源的页面不要设置"window.name"，要不然读到的就是他的值了。
                    </div>
                    <script>
                        window.name = "我的名字是： index.html";
                    </script>
                    <iframe id="frameWindowName1" src="//c1.ddz.com/windowName1.html" width="100%"></iframe>
                    <script>
                        var frameWindowName1Dom = document.getElementById("frameWindowName1"),
                            frameWindowNameIsSameDomain = false;
                        frameWindowName1Dom.onload = function () {
                            if (!frameWindowNameIsSameDomain) {
                                frameWindowName1Dom.src = '//ddz.com/windowName0.html';
                                frameWindowNameIsSameDomain = true;
                            } else {
                                alert("读取这个值好难啊：" + frameWindowName1Dom.contentWindow.name);
                            }
                        }
                    </script>
                </dd>
                <dt>postMessage</dt>
                <dd>
                    <button type="button" id="btnPostMessage1">发送消息</button>
                    <iframe id="framePostMessage1" src="//c1.ddz.com/postMessage1.html" width="100%"></iframe>
                    <script>
                        document.getElementById("btnPostMessage1").onclick = function () {
                            document.getElementById('framePostMessage1').contentWindow.postMessage(
                                '大家好，我是index.html',
                                'http://c1.ddz.com');
                        }
                    </script>
                </dd>
                <dt>JSONP</dt>
                <dd>
                    <div class="help-text">这里调用<strong>JSONP 教程 | 菜鸟教程</strong>获取数据</div>
                    <div id="divCustomers"></div>
                </dd>
                <dt>代理服务器、WebSocket、CORS</dt>
                <dd>这几种方式都和服务器端相关并且不太好测试，这里暂时就不写了……以后再说</dd>
            </dl>
        </fieldset>
    </div>
    <script src="https://unpkg.zhimg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script src="https://unpkg.zhimg.com/jquery"></script>
    <script>
        var slider = new mdc.slider.MDCSlider(document.querySelector('.mdc-slider'));
        $.getJSON("https://www.runoob.com/try/ajax/jsonp.php?jsoncallback=?", function (data) {
            var html = '<ul>';
            for (var i = 0; i < data.length; i++) {
                html += '<li>' + data[i] + '</li>';
            }
            html += '</ul>';
            $('#divCustomers').html(html);
        });
    </script>

</body>

</html>